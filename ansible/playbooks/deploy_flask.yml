- name: Deploy Flask app to Flask instances
  hosts: tag_flask
  become: yes

  tasks:
    - name: Install required packages
      package:
        name:
          - python3
          - python3-pip
        state: present

    - name: Install Flask
      pip:
        name: flask

    - name: Create /tmp directory
      file:
        path: /tmp
        state: directory
        mode: '0755'

    - name: Download app artifact from Nexus
      get_url:
        url: http://35.183.72.244:8081/repository/flask-devops-artifacts/app-artifact.tar.gz
        dest: /tmp/app-artifact.tar.gz
        mode: '0644'
        url_username: admin
        url_password: tomison   # ðŸ”¥ change this to your real Nexus password

    - name: Create app directory
      file:
        path: /home/{{ ansible_user }}/app
        state: directory
        mode: '0755'

    - name: Extract application files
      unarchive:
        src: /tmp/app-artifact.tar.gz
        dest: /home/{{ ansible_user }}/app
        remote_src: yes

    - name: Start Flask app
      shell: |
        cd /home/{{ ansible_user }}/app
        nohup flask run --host=0.0.0.0 --port=5000 &
      args:
        executable: /bin/bash

